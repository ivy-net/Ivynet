<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Handling fluentd logs
<label @FLUENT_LOG>
  <filter fluent.*>
    @type record_transformer
    enable_ruby
    <record>
      container_name "fluentd"
      log ${record["message"]}
      log_level "${\
        log = record['log']
        if log =~ /ERR/
          'ERROR'
        elsif log =~ /WRN/
          'WARNING'
        elsif log =~ /INF/
          'INFO'
        elsif log =~ /DBG/
          'DEBUG'
        else
          'UNKNOWN'
        end
      }"
      created_at ${Time.now.to_i}
    </record>
    remove_keys message
  </filter>

<match fluent.**>
  @type copy
  <store>
    @type file
    path /fluentd/log/${tag}/%Y-%m-%d
    append true
    <buffer tag,time>
      @type file
      timekey 1d
      timekey_use_utc true
      timekey_wait 10m
      flush_mode interval
      flush_interval 5s
    </buffer>
    <format>
      @type json
    </format>
  </store>
  <store>
    @type http
    endpoint http://host.docker.internal:50051/post_log
    open_timeout 2
    <format>
      @type json
    </format>
    json_array true
    <buffer>
      flush_interval 10s
    </buffer>
  </store>
</match>
</label>

# Handling all other logs
<filter **>
  @type record_transformer
  enable_ruby
  <record>
    log_level "${\
    log = record['log']
      if log =~ /ERR/
        'ERROR'
      elsif log =~ /WRN/
        'WARNING'
      elsif log =~ /INF/
        'INFO'
      elsif log =~ /DBG/
        'DEBUG'
      else
        'UNKNOWN'
      end
    }"
    created_at ${Time.now.to_i}
  </record>
</filter>

<match **>
  @type copy
  <store>
    @type file
    path /fluentd/log/${tag}/${chain}/%Y-%m-%d
    append true
    <buffer tag,time,chain>
      @type file
      timekey 1d
      timekey_use_utc true
      timekey_wait 10m
      flush_mode interval
      flush_interval 5s
    </buffer>
    <format>
      @type json
    </format>
  </store>
  <store>
    @type http
    endpoint http://host.docker.internal:50051/post_log
    open_timeout 2
    <format>
      @type json
    </format>
    json_array true
    <buffer>
      flush_interval 10s
    </buffer>
  </store>
</match>
