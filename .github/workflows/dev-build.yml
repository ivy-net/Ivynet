---
name: Build and Tag on Merge

on:
  pull_request:
    types:
      - closed
    branches:
      - dev

jobs:

  build:
    name: Build everything
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: >
          sudo apt install
          protobuf-compiler
          pkg-config
          libssl-dev
      - name: Install official Rust
        run: >
          curl
          --proto '=https'
          --tlsv1.2
          -sSf
          https://sh.rustup.rs
          |
          sh -s -- -y
      - name: Build binaries
        run: |
          . "$HOME/.cargo/env"
          cargo build --release


  tag-backend:
    name: Tag backend
    if: github.event.pull_request.merged == true
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Install official Rust
        run: >
          curl
          --proto '=https'
          --tlsv1.2
          -sSf
          https://sh.rustup.rs
          |
          sh -s -- -y
      - name: Install TOML cli
        run: |
          . "$HOME/.cargo/env"
          cargo install toml-cli
          echo "path: $PATH"
      - name: Extract TOML version
        id: version-backend
        run: |
          version=$(toml get backend/Cargo.toml package.version)
          echo "::set-output name=version::$version"
      - name: Get latest git tag
        id: tag-backend
        run: |
          tag=$(git tag | awk -F- '/backend/ {print $2}')
          echo "::set-output name=tag::$tag"
      - name: Create new git tag
        if: >
          steps.version-backend.outputs.version
          !=
          steps.tag-backend.outputs.tag
        run: |
          git tag -f backend-${{ steps.version-backend.outputs.version }}
          git push origin backend-${{ steps.version-backend.outputs.version }}

  tag-cli:
    name: Tag client
    if: github.event.pull_request.merged == true
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Install official Rust
        run: >
          curl
          --proto '=https'
          --tlsv1.2
          -sSf
          https://sh.rustup.rs
          |
          sh -s -- -y
      - name: Install TOML cli
        run: |
          . "$HOME/.cargo/env"
          cargo install toml-cli
      - name: Extract TOML version
        id: version-cli
        run: |
          version=$(toml get cli/Cargo.toml package.version)
          echo "::set-output name=version::$version"
      - name: Get latest tag
        id: tag-cli
        run: |
          tag=$(git tag | awk -F- '/client/ {print $2}')
          echo "::set-output name=tag::$tag"
      - name: Create git tag
        if: >
          steps.version-cli.outputs.version
          !=
          steps.tag-cli.outputs.tag
        run: |
          git tag -f client-${{ steps.version-cli.outputs.version }}
          git push origin client-${{ steps.version-cli.outputs.version }}
